steps:
  - name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - -c
      - docker build -t gcr.io/$PROJECT_ID/gcp-fastapi-poetry:latest -f Dockerfile .

  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/gcp-fastapi-poetry:latest"]

  # Deploy service image to Cloud Run
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - -c
      - >
        gcloud
        run deploy gcp-fastapi-poetry
        --cpu 1
        --memory 256M
        --max-instances 5
        --image gcr.io/$PROJECT_ID/gcp-fastapi-poetry:latest
        --region europe-west1
        --platform managed
        --allow-unauthenticated
        --set-env-vars TEMPLATES_READER_TOKEN=$$TEMPLATES_READER_TOKEN,TEMPLATES_REPO_OWNER=$$TEMPLATES_REPO_OWNER,TEMPLATES_REPO_NAME=$$TEMPLATES_REPO_NAME
    secretEnv:
      ["TEMPLATES_READER_TOKEN", "TEMPLATES_REPO_OWNER", "TEMPLATES_REPO_NAME"]

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/TEMPLATES_READER_TOKEN/versions/latest
      env: "TEMPLATES_READER_TOKEN"
    - versionName: projects/$PROJECT_ID/secrets/TEMPLATES_REPO_OWNER/versions/latest
      env: "TEMPLATES_REPO_OWNER"
    - versionName: projects/$PROJECT_ID/secrets/TEMPLATES_REPO_NAME/versions/latest
      env: "TEMPLATES_REPO_NAME"
